<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
    <style>
        body {
            margin: 0;
            font-family: monospace;
            width: 100vw;
            height: 100vh;
        }

        #sceneCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #shadersViewer {
            width: 28%;
            height: 100%;
            overflow: auto;
            top:0px;
            left: 0px;
            margin: 0px;
            position: absolute;
            background: rgba(29, 29, 29, 0.55);
            color: white;
        }
    </style>
    <link rel="shortcut icon" href="">
</head>

<body>
    <canvas id="sceneCanvas" width="624" height="710"></canvas>
    <textarea id="shadersViewer"></textarea>
    <script src="js/externals/twgl-full.min.js"></script>
    <script src="js/externals/stats.min.js"></script>
    <script src="js/externals/dat.gui.min.js"></script>
    <script src="js/io.js"></script>
    <script src="js/shaders.js"></script>
</body>

<script>
// =============================================================================
// TWGL specific globals.
// =============================================================================
const m4     = twgl.m4;
const v3     = twgl.v3;
const canvas = document.querySelector("#sceneCanvas");
const gl     = canvas.getContext("webgl");
twgl.setDefaults({attribPrefix: "a_"});

// =============================================================================
//  Steering setup.
// =============================================================================
document.onkeydown   = IO.handleKeyDown;
document.onkeyup     = IO.handleKeyUp;
document.onmouseup   = IO.handleMouseUp;
document.onmousemove = IO.handleMouseMove;
canvas.onmousedown   = IO.handleMouseDown;

// =============================================================================
// Initialize statistics panel.
// =============================================================================
var statsFPS = new Stats();
statsFPS.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
statsFPS.dom.style.cssText = 'position:absolute;bottom:0px;right:160px;';
document.body.appendChild(statsFPS.dom);

var statsMBs = new Stats();
statsMBs.showPanel(2); // Panel 1 = ms
statsMBs.dom.style.cssText = 'position:absolute;bottom:0px;right:80px;';
document.body.appendChild(statsMBs.dom);

var statsMs = new Stats();
statsMs.showPanel(1); // Panel 1 = ms
statsMs.dom.style.cssText = 'position:absolute;bottom:0px;right:0px;';
document.body.appendChild(statsMs.dom);

// =============================================================================
//  Shaders Viewer Panel.
// =============================================================================
const shaderCodeBox = document.querySelector('#shadersViewer');
const shaderCode    = document.createTextNode(`${pbrVS}\n${pbrFG}`);
shaderCodeBox.appendChild(shaderCode);

// =============================================================================
//  MVP/viewport.
// =============================================================================
const projection = m4.identity();
let   view       = m4.identity();
const fov        = 45 * Math.PI / 180;
const near       = 0.01;
const far        = 1000.0;

// =============================================================================
// Load Textures.
// =============================================================================
const textures = twgl.createTextures(gl, {
  albedo:    {src: `./res/rustediron-streaks_basecolor.png`},
  metallic:  {src: `./res/rustediron-streaks_metallic.png`},
  normal:    {src: `./res/rustediron-streaks_normal.png`},
  roughness: {src: `./res/rustediron-streaks_roughness.png`},
});

// =============================================================================
//  Load Geometry.
// =============================================================================
let   sphereModelMatrix        = m4.identity();
const sphereRadius             = 1.0;
const sphereSubdivisionsAxis   = 20;
const sphereSubdivisionsHeight = 20;
const sphereBufferI            = twgl.primitives.createSphereBufferInfo(
                                 gl,
                                 sphereRadius,
                                 sphereSubdivisionsAxis,
                                 sphereSubdivisionsHeight);

// =============================================================================
//  Load shaders.
// =============================================================================
const sphereProgram = twgl.createProgramInfo(gl, [pbrVS, pbrFG]);

// =============================================================================
//  Load uniforms.
// =============================================================================
const sphereUniforms = {
    u_model:      sphereModelMatrix,
    u_view:       view,
    u_projection: projection,
    u_color:      [1.0, 0.0, 0.0],
    u_albedo:     textures.albedo,
    u_metallic:   textures.metallic,
    u_normal:     textures.normal,
    u_roughness:  textures.roughness,
};

// =============================================================================
//  Utilities.
// =============================================================================
const updateViewMatrix = function () {
    SpectatorCamera.getViewMatrix(view);
    m4.inverse(view, view);
}

const renderSphere = function () {
    gl.useProgram(sphereProgram.program);
    twgl.setUniforms(sphereProgram, sphereUniforms);
    twgl.setBuffersAndAttributes(gl, sphereProgram, sphereBufferI);
    twgl.drawBufferInfo(gl, sphereBufferI);
}

// =============================================================================
//  Rendering function.
// =============================================================================
function render(time) {
    statsFPS.begin();
    statsMBs.begin();
    statsMs.begin();
    IO.handleKeyboard();
    updateViewMatrix();

    twgl.resizeCanvasToDisplaySize(gl.canvas);
    m4.perspective(fov, gl.canvas.clientWidth / gl.canvas.clientHeight, near,
                   far, projection);
    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

    gl.enable(gl.DEPTH_TEST);
    gl.clearColor(0.1132, 0.1132, 0.1132, 1.0);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    // rgb(43,87,151)
    renderSphere();

    statsMs.end();
    statsMBs.end();
    statsFPS.end();
    requestAnimationFrame(render);
}

requestAnimationFrame(render);

</script>

</html>
